# v1.0 Code Review Findings

**Date:** 2025-11-30
**Source:** Pre-release code review
**Priority:** Medium - can ship v1.0, address in patch releases

---

## Warning Items

### 1. SVG Extraction Fallback Returns Raw Content

**Location:** `src/infrastructure/ai/orchestration/SVGOrchestrator.ts:194`

**Issue:** `extractSVG()` returns content as-is if no SVG tags found. Could return error messages or explanations that get displayed as "SVG code".

**Fix:** Throw an error instead of returning raw content:
```typescript
throw new Error('No valid SVG code found in response');
```

---

### 2. Image Client Silently Skips Malformed Images

**Location:** `src/infrastructure/ai/clients/OpenRouterImageClient.ts:84-101`

**Issue:** If OpenRouter returns images with missing URLs or invalid data URLs, they're skipped with just a warning. Users see fewer images than expected with no explanation.

**Fix:** Either throw if any image is malformed, or send a warning to the webview so users understand why they got fewer images.

---

### 3. No Conversation Cleanup (Memory Leak Potential)

**Location:** `ImageConversationManager.ts`, `SVGConversationManager.ts`, `TextConversationManager.ts`

**Issue:** Conversations stored in `Map` with no expiration. Old conversations persist indefinitely, including base64 image data.

**Fix:** Implement cleanup policy:
- Clear on extension reload
- Or add TTL (e.g., 1 hour of inactivity)
- Or limit to N most recent conversations

---

### 4. TextOrchestrator Returns Fake Response for Max Turns

**Location:** `src/infrastructure/ai/orchestration/TextOrchestrator.ts:91-97`

**Issue:** When max turns reached, returns a synthetic response string instead of throwing. Users may think the AI is telling them to start a new conversation.

**Fix:** Throw an error and let handler send proper ERROR message type.

---

### 5. No Abort/Cancellation for Long Operations

**Location:** AI clients (`OpenRouterTextClient.ts`, `OpenRouterDynamicTextClient.ts`, `OpenRouterImageClient.ts`)

**Issue:** Clients accept `signal` option but handlers don't pass AbortController. Long-running requests can't be cancelled.

**Fix:** Add timeout/cancellation support in handlers, pass AbortController to clients.

---

### 6. SVG Concurrent Requests May Race on Model

**Location:** `src/infrastructure/ai/orchestration/SVGOrchestrator.ts:88`

**Issue:** `setModel()` sets shared state on client. If two concurrent SVG requests use different models, they may race.

**Fix:** Pass model to `createCompletion()` directly instead of relying on shared `setModel()` state.

---

### 7. No MIME Type Validation for Images

**Location:** `src/application/handlers/domain/ImageGenerationHandler.ts:273-278`

**Issue:** Regex allows any `\w+` for image type. Could match invalid MIME types.

**Fix:** Validate against known types: `png`, `jpeg`, `webp`, `gif`.

---

## Info Items (Low Priority)

### 8. Text Client Created on Every Enhance Request

**Location:** `src/application/handlers/domain/EnhanceHandler.ts:78`

Create client once in MessageHandler and inject for consistency.

### 9. Inconsistent Error Logging

Various handlers log errors differently. Standardize on full error object for stack traces.

### 10. Default Model Hardcoded in Multiple Places

Model defaults in `OpenRouterTextClient.ts`, `OpenRouterDynamicTextClient.ts`, `EnhanceHandler.ts`. Consider centralizing.

---

## Resolved

- [x] **CRITICAL: Unhandled Promise Rejection** - Fixed in v1.0.0 release
  - Location: `src/application/providers/WebviewViewProvider.ts:55-59`
  - Fix: Added async/await and try-catch wrapper
